<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Quiz Generator</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Feather Icons for UI elements -->
    <script src="https://unpkg.com/feather-icons"></script>

    <!-- jsPDF Library for PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        /* Custom styles for a polished look */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* slate-50 */
        }
        .view {
            display: none;
        }
        .view.active {
            display: block;
        }
        /* Custom animation for loading spinner */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #4f46e5; /* indigo-600 */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        /* Custom styles for quiz options */
        .quiz-option input:checked + label {
            border-color: #4f46e5; /* indigo-600 */
            background-color: #eef2ff; /* indigo-50 */
            color: #3730a3; /* indigo-800 */
        }
        .quiz-option label {
            transition: all 0.2s ease-in-out;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9; /* slate-100 */
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; /* slate-300 */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; /* slate-400 */
        }
        /* Mode switcher active state */
        .mode-btn.active {
            background-color: white;
            color: #4338ca; /* indigo-700 */
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        }
    </style>
</head>
<body class="antialiased text-slate-800">

    <!-- Main Application Container -->
    <div id="app" class="min-h-screen flex flex-col">

        <!-- Header -->
        <header class="bg-white shadow-sm sticky top-0 z-10">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <div class="bg-indigo-600 p-2 rounded-lg">
                        <i data-feather="zap" class="text-white"></i>
                    </div>
                    <h1 class="text-2xl font-bold text-slate-900">Vismay | Project 4 </h1>
                </div>
                <button id="dashboard-btn" class="text-indigo-600 hover:text-indigo-800 font-medium flex items-center space-x-2">
                    <i data-feather="home" class="w-5 h-5"></i>
                    <span>Dashboard</span>
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-grow">
            <!-- Dashboard View -->
            <div id="dashboard-view" class="view active">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
                    <div class="flex justify-between items-center mb-8">
                        <h2 class="text-3xl font-bold text-slate-900">My Quizzes</h2>
                        <button id="create-new-quiz-btn" class="bg-indigo-600 text-white font-semibold px-6 py-3 rounded-lg shadow-md hover:bg-indigo-700 transition duration-300 flex items-center space-x-2">
                            <i data-feather="plus" class="w-5 h-5"></i>
                            <span>Create New Quiz</span>
                        </button>
                    </div>
                    <div id="quiz-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Quiz cards will be dynamically inserted here -->
                    </div>
                    <div id="no-quizzes-message" class="hidden text-center py-16 bg-slate-100 rounded-lg">
                        <i data-feather="file-text" class="w-16 h-16 mx-auto text-slate-400 mb-4"></i>
                        <h3 class="text-xl font-semibold text-slate-700">No quizzes yet!</h3>
                        <p class="text-slate-500 mt-2">Click "Create New Quiz" to get started.</p>
                    </div>
                </div>
            </div>

            <!-- Create Quiz View -->
            <div id="create-quiz-view" class="view">
                <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
                    <h2 class="text-3xl font-bold text-slate-900 mb-2">Create a New Quiz</h2>
                    <p class="text-slate-500 mb-8">Generate questions with AI or build your own from scratch.</p>
                    
                    <div class="bg-white p-8 rounded-xl shadow-lg">
                        <div class="mb-6">
                            <label for="quiz-title-input" class="block text-sm font-medium text-slate-700 mb-1">Quiz Title</label>
                            <input type="text" id="quiz-title-input" placeholder="e.g., World War II History" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        </div>

                        <!-- Mode Selector -->
                        <div class="mb-8">
                            <label class="block text-sm font-medium text-slate-700 mb-2">Choose Creation Mode</label>
                            <div class="flex rounded-lg p-1 bg-slate-200">
                                <button id="ai-mode-btn" class="mode-btn w-1/2 py-2 text-sm font-semibold rounded-md transition-colors">AI Mode</button>
                                <button id="manual-mode-btn" class="mode-btn w-1/2 py-2 text-sm font-semibold rounded-md transition-colors">Manual Mode</button>
                            </div>
                        </div>

                        <!-- AI Mode Container -->
                        <div id="ai-mode-container">
                             <div class="mb-6">
                                <label for="source-text" class="block text-sm font-medium text-slate-700 mb-1">Source Text</label>
                                <textarea id="source-text" rows="10" class="w-full p-4 border border-slate-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="Paste your article, notes, or any text here... The AI will generate questions based on this content. For best results, provide at least a few paragraphs."></textarea>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                                <div>
                                    <label for="num-questions" class="block text-sm font-medium text-slate-700 mb-1">Number of Questions</label>
                                    <select id="num-questions" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                                        <option>5</option>
                                        <option selected>10</option>
                                        <option>15</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="difficulty" class="block text-sm font-medium text-slate-700 mb-1">Difficulty</label>
                                    <select id="difficulty" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                                        <option>Easy</option>
                                        <option selected>Medium</option>
                                        <option>Hard</option>
                                    </select>
                                </div>
                            </div>
                            <button id="generate-quiz-btn" class="w-full bg-indigo-600 text-white font-semibold py-3 rounded-lg shadow-md hover:bg-indigo-700 transition duration-300 flex items-center justify-center space-x-2">
                                <i data-feather="zap" class="w-5 h-5"></i>
                                <span>Generate Quiz</span>
                            </button>
                        </div>
                    </div>

                    <!-- Loading Indicator -->
                    <div id="loading-indicator" class="hidden text-center py-12">
                        <div class="spinner mx-auto"></div>
                        <p class="text-slate-600 mt-4 font-medium">AI is generating your quiz... This may take a moment.</p>
                    </div>

                    <!-- Quiz Editor -->
                    <div id="quiz-editor" class="hidden mt-12">
                        <div class="mb-6">
                            <h3 class="text-2xl font-bold text-slate-900">Quiz Editor</h3>
                        </div>
                        <div id="questions-container" class="space-y-6">
                            <!-- Generated/manual questions will be inserted here -->
                        </div>
                        
                        <div class="mt-6 border-t border-slate-200 pt-6">
                            <button id="add-question-btn" class="w-full bg-slate-100 text-slate-700 font-semibold py-3 rounded-lg hover:bg-slate-200 transition duration-300 flex items-center justify-center space-x-2">
                                <i data-feather="plus" class="w-5 h-5"></i>
                                <span>Add Another Question</span>
                            </button>
                        </div>

                        <div class="flex justify-end space-x-4 mt-8">
                            <button id="download-pdf-btn" class="bg-blue-600 text-white font-semibold px-6 py-3 rounded-lg shadow-md hover:bg-blue-700 transition duration-300 flex items-center space-x-2">
                                <i data-feather="download" class="w-5 h-5"></i>
                                <span>Download PDF</span>
                            </button>
                            <button id="save-quiz-btn" class="bg-green-600 text-white font-semibold px-6 py-3 rounded-lg shadow-md hover:bg-green-700 transition duration-300 flex items-center space-x-2">
                                <i data-feather="save" class="w-5 h-5"></i>
                                <span>Save Quiz</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Take Quiz View -->
            <div id="take-quiz-view" class="view">
                 <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
                    <div class="bg-white p-8 rounded-xl shadow-lg">
                        <div class="flex justify-between items-start mb-6">
                            <div>
                                <h2 id="quiz-take-title" class="text-3xl font-bold text-slate-900"></h2>
                                <p class="text-slate-500">Answer the questions below.</p>
                            </div>
                            <div id="timer" class="text-lg font-semibold bg-indigo-100 text-indigo-800 px-4 py-2 rounded-lg">
                                10:00
                            </div>
                        </div>
                        <div id="quiz-questions-area" class="space-y-8">
                            <!-- Quiz questions for the user will be rendered here -->
                        </div>
                        <div class="mt-8 border-t pt-6 flex justify-end">
                            <button id="submit-quiz-btn" class="bg-indigo-600 text-white font-semibold px-8 py-3 rounded-lg shadow-md hover:bg-indigo-700 transition duration-300">Submit Quiz</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results View -->
            <div id="results-view" class="view">
                <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
                    <div class="bg-white p-8 rounded-xl shadow-lg text-center">
                        <h2 class="text-2xl font-bold text-slate-900 mb-2">Quiz Completed!</h2>
                        <p class="text-slate-500 mb-6">Here's how you did:</p>
                        
                        <div class="mb-8">
                            <div id="score-circle" class="w-40 h-40 rounded-full mx-auto flex items-center justify-center text-4xl font-bold">
                                <span id="final-score"></span>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center mb-8">
                            <div class="bg-slate-100 p-4 rounded-lg">
                                <p class="text-sm text-slate-500">Correct Answers</p>
                                <p id="correct-answers" class="text-2xl font-bold text-green-600"></p>
                            </div>
                            <div class="bg-slate-100 p-4 rounded-lg">
                                <p class="text-sm text-slate-500">Incorrect Answers</p>
                                <p id="incorrect-answers" class="text-2xl font-bold text-red-600"></p>
                            </div>
                            <div class="bg-slate-100 p-4 rounded-lg">
                                <p class="text-sm text-slate-500">Time Taken</p>
                                <p id="time-taken" class="text-2xl font-bold text-slate-800"></p>
                            </div>
                        </div>
                        
                        <h3 class="text-xl font-bold text-slate-800 mb-6">Review Your Answers</h3>
                        <div id="answer-review-area" class="space-y-4 text-left">
                            <!-- Answer review will be rendered here -->
                        </div>
                        
                        <button id="back-to-dashboard-btn" class="mt-8 bg-indigo-600 text-white font-semibold px-6 py-3 rounded-lg shadow-md hover:bg-indigo-700 transition duration-300">Back to Dashboard</button>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="bg-white mt-auto">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 text-center text-slate-500">
                <p>&copy; 2024 Vismay Rathod. All rights reserved.</p>
            </div>
        </footer>
    </div>

    <!-- Custom Modal for Confirmations -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl max-w-sm w-full">
            <h3 id="modal-title" class="text-lg font-bold text-slate-900 mb-4">Are you sure?</h3>
            <p id="modal-message" class="text-slate-600 mb-6">This action cannot be undone.</p>
            <div class="flex justify-end space-x-4">
                <button id="modal-cancel-btn" class="px-4 py-2 bg-slate-200 text-slate-800 rounded-lg hover:bg-slate-300">Cancel</button>
                <button id="modal-confirm-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Confirm</button>
            </div>
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- STATE MANAGEMENT ---
        let quizzes = [];
        let currentQuizForEditing = null;
        let quizTimer;

        // --- DOM ELEMENTS ---
        const views = document.querySelectorAll('.view');
        const dashboardBtn = document.getElementById('dashboard-btn');
        const createNewQuizBtn = document.getElementById('create-new-quiz-btn');
        const generateQuizBtn = document.getElementById('generate-quiz-btn');
        const saveQuizBtn = document.getElementById('save-quiz-btn');
        const submitQuizBtn = document.getElementById('submit-quiz-btn');
        const backToDashboardBtn = document.getElementById('back-to-dashboard-btn');
        const addQuestionBtn = document.getElementById('add-question-btn');
        const downloadPdfBtn = document.getElementById('download-pdf-btn');
        
        const quizList = document.getElementById('quiz-list');
        const noQuizzesMessage = document.getElementById('no-quizzes-message');
        const loadingIndicator = document.getElementById('loading-indicator');
        const quizEditor = document.getElementById('quiz-editor');
        const questionsContainer = document.getElementById('questions-container');

        const aiModeBtn = document.getElementById('ai-mode-btn');
        const manualModeBtn = document.getElementById('manual-mode-btn');
        const aiModeContainer = document.getElementById('ai-mode-container');

        const modal = document.getElementById('confirmation-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');

        // --- NAVIGATION ---
        const showView = (viewId) => {
            views.forEach(view => view.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            window.scrollTo(0, 0);
        };

        // --- LOCAL STORAGE ---
        const loadQuizzesFromStorage = () => {
            const storedQuizzes = localStorage.getItem('aiQuizAppQuizzes');
            if (storedQuizzes) quizzes = JSON.parse(storedQuizzes);
        };

        const saveQuizzesToStorage = () => {
            localStorage.setItem('aiQuizAppQuizzes', JSON.stringify(quizzes));
        };

        // --- MODAL LOGIC ---
        const showModal = (title, message, onConfirm = null) => {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            
            const newConfirmBtn = modalConfirmBtn.cloneNode(true);
            const currentConfirmBtn = document.getElementById('modal-confirm-btn');
            currentConfirmBtn.parentNode.replaceChild(newConfirmBtn, currentConfirmBtn);
             
            if (onConfirm) {
                newConfirmBtn.style.display = 'inline-flex';
                newConfirmBtn.addEventListener('click', () => {
                    onConfirm();
                    hideModal();
                });
                modalCancelBtn.textContent = 'Cancel';
            } else {
                newConfirmBtn.style.display = 'none';
                modalCancelBtn.textContent = 'OK';
            }

            modal.classList.remove('hidden');
        };

        const hideModal = () => {
            modal.classList.add('hidden');
        };

        // --- RENDER FUNCTIONS ---
        const renderDashboard = () => {
            quizList.innerHTML = '';
            if (quizzes.length === 0) {
                noQuizzesMessage.classList.remove('hidden');
            } else {
                noQuizzesMessage.classList.add('hidden');
                quizzes.forEach((quiz, index) => {
                    const card = document.createElement('div');
                    card.className = 'bg-white p-6 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300 flex flex-col';
                    card.innerHTML = `
                        <div class="flex-grow">
                            <h3 class="text-xl font-bold text-slate-900 mb-2">${quiz.title}</h3>
                            <p class="text-slate-500 mb-4">${quiz.questions.length} Questions</p>
                        </div>
                        <div class="flex justify-end space-x-2 mt-4">
                            <button data-action="delete" data-index="${index}" class="p-2 text-slate-500 hover:bg-red-100 hover:text-red-600 rounded-full"><i data-feather="trash-2" class="w-5 h-5"></i></button>
                            <button data-action="start" data-index="${index}" class="bg-indigo-100 text-indigo-700 font-semibold px-4 py-2 rounded-lg hover:bg-indigo-200 transition duration-300">Start Quiz</button>
                        </div>
                    `;
                    quizList.appendChild(card);
                });
            }
            feather.replace();
        };

        const renderQuizEditor = (questions) => {
            questionsContainer.innerHTML = '';
            questions.forEach((q, index) => {
                const questionCard = document.createElement('div');
                questionCard.className = 'bg-slate-50 p-6 rounded-lg border border-slate-200';
                questionCard.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <label class="block text-sm font-bold text-slate-700">Question ${index + 1}</label>
                        <button data-action="delete-question" data-index="${index}" class="p-2 text-slate-400 hover:bg-red-100 hover:text-red-600 rounded-full"><i data-feather="x" class="w-5 h-5"></i></button>
                    </div>
                    <textarea data-type="question-text" class="w-full p-2 border border-slate-300 rounded-lg mb-4">${q.question}</textarea>
                    <div class="space-y-2">
                        ${q.options.map((opt, optIndex) => `
                            <div class="flex items-center">
                                <input type="radio" name="correct-answer-${index}" value="${optIndex}" ${q.answer === optIndex ? 'checked' : ''} class="mr-2 h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-slate-300">
                                <input type="text" data-type="option-text" value="${opt}" class="w-full p-2 border border-slate-300 rounded-lg">
                            </div>
                        `).join('')}
                    </div>
                `;
                questionsContainer.appendChild(questionCard);
            });
            quizEditor.classList.remove('hidden');
            feather.replace();
        };

        const renderQuizTaker = (quiz) => {
            document.getElementById('quiz-take-title').textContent = quiz.title;
            const questionsArea = document.getElementById('quiz-questions-area');
            questionsArea.innerHTML = '';
            quiz.questions.forEach((q, index) => {
                const questionEl = document.createElement('div');
                questionEl.innerHTML = `
                    <p class="font-semibold text-lg mb-4">${index + 1}. ${q.question}</p>
                    <div class="space-y-3">
                        ${q.options.map((opt, optIndex) => `
                            <div class="quiz-option">
                                <input type="radio" id="q${index}-opt${optIndex}" name="question-${index}" value="${optIndex}" class="hidden">
                                <label for="q${index}-opt${optIndex}" class="block w-full p-4 border-2 border-slate-200 rounded-lg cursor-pointer hover:border-indigo-400">${opt}</label>
                            </div>
                        `).join('')}
                    </div>
                `;
                questionsArea.appendChild(questionEl);
            });
        };

        const renderResults = (quiz, userAnswers, time) => {
            let correctCount = 0;
            quiz.questions.forEach((q, index) => {
                if (userAnswers[index] !== null && parseInt(userAnswers[index]) === q.answer) {
                    correctCount++;
                }
            });

            const scorePercentage = quiz.questions.length > 0 ? (correctCount / quiz.questions.length) * 100 : 0;
            const scoreCircle = document.getElementById('score-circle');
            
            document.getElementById('final-score').textContent = `${Math.round(scorePercentage)}%`;
            if (scorePercentage >= 70) {
                scoreCircle.className = 'w-40 h-40 rounded-full mx-auto flex items-center justify-center text-4xl font-bold bg-green-100 text-green-700';
            } else if (scorePercentage >= 40) {
                scoreCircle.className = 'w-40 h-40 rounded-full mx-auto flex items-center justify-center text-4xl font-bold bg-yellow-100 text-yellow-700';
            } else {
                scoreCircle.className = 'w-40 h-40 rounded-full mx-auto flex items-center justify-center text-4xl font-bold bg-red-100 text-red-700';
            }
            
            document.getElementById('correct-answers').textContent = correctCount;
            document.getElementById('incorrect-answers').textContent = quiz.questions.length - correctCount;
            document.getElementById('time-taken').textContent = time;

            const reviewArea = document.getElementById('answer-review-area');
            reviewArea.innerHTML = '';
            quiz.questions.forEach((q, index) => {
                const userAnswer = userAnswers[index] !== null ? parseInt(userAnswers[index]) : -1;
                const isCorrect = userAnswer === q.answer;
                const reviewEl = document.createElement('div');
                reviewEl.className = `p-4 rounded-lg border-l-4 ${isCorrect ? 'bg-green-50 border-green-500' : 'bg-red-50 border-red-500'}`;
                reviewEl.innerHTML = `
                    <p class="font-semibold mb-2">${index + 1}. ${q.question}</p>
                    <p class="text-sm ${isCorrect ? 'text-green-700' : 'text-red-700'}">
                        Your answer: ${userAnswer !== -1 ? q.options[userAnswer] : 'Not answered'}
                    </p>
                    ${!isCorrect ? `<p class="text-sm text-green-700">Correct answer: ${q.options[q.answer]}</p>` : ''}
                `;
                reviewArea.appendChild(reviewEl);
            });
        };
        
        // --- QUIZ CREATION MODE ---
        const switchToAIMode = () => {
            aiModeBtn.classList.add('active');
            manualModeBtn.classList.remove('active');
            aiModeContainer.style.display = 'block';
            quizEditor.classList.add('hidden');
        };
        
        const switchToManualMode = () => {
            manualModeBtn.classList.add('active');
            aiModeBtn.classList.remove('active');
            aiModeContainer.style.display = 'none';
            loadingIndicator.classList.add('hidden');
            
            currentQuizForEditing = { questions: [] };
            addNewQuestionToEditor();
            quizEditor.classList.remove('hidden');
        };

        // --- EVENT HANDLERS ---
        dashboardBtn.addEventListener('click', () => showView('dashboard-view'));
        
        createNewQuizBtn.addEventListener('click', () => {
            document.getElementById('quiz-title-input').value = '';
            document.getElementById('source-text').value = '';
            quizEditor.classList.add('hidden');
            switchToAIMode(); // Default to AI mode
            showView('create-quiz-view');
        });

        aiModeBtn.addEventListener('click', switchToAIMode);
        manualModeBtn.addEventListener('click', switchToManualMode);

        generateQuizBtn.addEventListener('click', async () => {
            const sourceText = document.getElementById('source-text').value;
            const numQuestions = document.getElementById('num-questions').value;
            const difficulty = document.getElementById('difficulty').value;
            
            if (sourceText.trim().length < 100) {
                showModal('Input Too Short', 'Please provide at least 100 characters of source text for better results.');
                return;
            }

            loadingIndicator.classList.remove('hidden');
            quizEditor.classList.add('hidden');
            generateQuizBtn.disabled = true;

            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const systemPrompt = "You are an expert quiz creator. Your task is to generate a multiple-choice quiz based strictly on the provided text. The questions should be clear and directly answerable from the text. Each question must have exactly 4 plausible options. Indicate the correct answer by providing its zero-based index.";
            const userPrompt = `Generate a quiz with ${numQuestions} questions of ${difficulty} difficulty. The quiz must be based entirely on the following text: "${sourceText}"`;
            const payload = {
                contents: [{ parts: [{ text: userPrompt }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                "question": { "type": "STRING" },
                                "options": { "type": "ARRAY", "items": { "type": "STRING" } },
                                "answer": { "type": "NUMBER", "description": "The 0-based index of the correct option." }
                            },
                            required: ["question", "options", "answer"]
                        }
                    }
                }
            };
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(`API Error: ${response.status} ${response.statusText}`);
                const result = await response.json();
                if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0].text) {
                    const jsonText = result.candidates[0].content.parts[0].text;
                    const questions = JSON.parse(jsonText);
                    currentQuizForEditing = { questions };
                    renderQuizEditor(questions);
                } else {
                    throw new Error("Invalid response structure from AI.");
                }
            } catch (error) {
                console.error("Error generating quiz:", error);
                showModal('Generation Failed', 'Sorry, there was an error generating the quiz. Please try again.');
            } finally {
                loadingIndicator.classList.add('hidden');
                generateQuizBtn.disabled = false;
            }
        });
        
        const getCurrentQuizFromEditor = () => {
            const updatedQuestions = [];
            const questionCards = questionsContainer.querySelectorAll('.bg-slate-50');
            questionCards.forEach((card) => {
                const questionText = card.querySelector('[data-type="question-text"]').value;
                const options = Array.from(card.querySelectorAll('[data-type="option-text"]')).map(input => input.value);
                const answerInput = card.querySelector('input[type="radio"]:checked');
                const answer = answerInput ? parseInt(answerInput.value) : 0;
                updatedQuestions.push({ question: questionText, options, answer });
            });
            return updatedQuestions;
        };

        saveQuizBtn.addEventListener('click', () => {
            const title = document.getElementById('quiz-title-input').value.trim();
            if (!title) {
                showModal('Title Required', 'Please enter a quiz title.');
                return;
            }

            const updatedQuestions = getCurrentQuizFromEditor();
            if (updatedQuestions.length === 0) {
                 showModal('No Questions', 'Please add at least one question before saving.');
                 return;
            }
            quizzes.push({ id: Date.now(), title, questions: updatedQuestions });
            
            saveQuizzesToStorage();
            renderDashboard();
            showView('dashboard-view');
        });

        downloadPdfBtn.addEventListener('click', () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const title = document.getElementById('quiz-title-input').value.trim() || "Untitled Quiz";
            const questions = getCurrentQuizFromEditor();

            if (questions.length === 0) {
                showModal('No Questions', 'Please add at least one question to generate a PDF.');
                return;
            }

            doc.setFontSize(18);
            doc.text(title, 105, 20, { align: 'center' });

            let y = 40;
            const pageHeight = doc.internal.pageSize.height;
            const margin = 20;

            questions.forEach((q, index) => {
                if (y > pageHeight - margin) {
                    doc.addPage();
                    y = 20;
                }
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                const questionText = doc.splitTextToSize(`${index + 1}. ${q.question}`, 180);
                doc.text(questionText, 15, y);
                y += (questionText.length * 5) + 5;
                doc.setFont(undefined, 'normal');
                q.options.forEach((opt, optIndex) => {
                    if (y > pageHeight - margin) {
                        doc.addPage();
                        y = 20;
                    }
                    const optionPrefix = optIndex === q.answer ? '(Correct Answer) ' : '';
                    const optionText = doc.splitTextToSize(`${String.fromCharCode(65 + optIndex)}. ${optionPrefix}${opt}`, 170);
                    doc.text(optionText, 20, y);
                    y += (optionText.length * 5) + 2;
                });
                y += 10;
            });
            doc.save(`${title.replace(/\s+/g, '_')}.pdf`);
        });

        const addNewQuestionToEditor = () => {
             if (!currentQuizForEditing) return;
            const newQuestion = {
                question: 'Enter your new question here.',
                options: ['Option A', 'Option B', 'Option C', 'Option D'],
                answer: 0
            };
            currentQuizForEditing.questions.push(newQuestion);
            renderQuizEditor(currentQuizForEditing.questions);
            const questionCards = questionsContainer.querySelectorAll('.bg-slate-50');
            if (questionCards.length > 0) {
                questionCards[questionCards.length - 1].scrollIntoView({ behavior: 'smooth' });
            }
        };

        addQuestionBtn.addEventListener('click', addNewQuestionToEditor);

        quizList.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (!button) return;
            const action = button.dataset.action;
            const index = parseInt(button.dataset.index);
            if (action === 'delete') {
                showModal('Delete Quiz', `Are you sure you want to delete the quiz "${quizzes[index].title}"?`,
                    () => {
                        quizzes.splice(index, 1);
                        saveQuizzesToStorage();
                        renderDashboard();
                    }
                );
            } else if (action === 'start') {
                startQuiz(index);
            }
        });

        questionsContainer.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (button && button.dataset.action === 'delete-question') {
                const index = parseInt(button.dataset.index);
                currentQuizForEditing.questions.splice(index, 1);
                renderQuizEditor(currentQuizForEditing.questions);
            }
        });

        submitQuizBtn.addEventListener('click', () => {
            showModal('Submit Quiz', 'Are you sure you want to submit your answers?',
                () => {
                    clearInterval(quizTimer);
                    const quizIndex = parseInt(submitQuizBtn.dataset.quizIndex);
                    const quiz = quizzes[quizIndex];
                    const userAnswers = [];
                    quiz.questions.forEach((_, index) => {
                        const selectedOption = document.querySelector(`input[name="question-${index}"]:checked`);
                        userAnswers.push(selectedOption ? selectedOption.value : null);
                    });
                    
                    const timeTakenString = document.getElementById('timer').textContent;
                    const [startMinutes] = [10]; // Assuming 10 min timer
                    const [endMinutes, endSeconds] = timeTakenString.split(':').map(Number);
                    const totalSecondsElapsed = (startMinutes * 60) - (endMinutes * 60 + endSeconds);
                    const minutes = Math.floor(totalSecondsElapsed / 60);
                    const seconds = totalSecondsElapsed % 60;
                    const formattedTime = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    renderResults(quiz, userAnswers, formattedTime);
                    showView('results-view');
                }
            );
        });

        backToDashboardBtn.addEventListener('click', () => {
            renderDashboard();
            showView('dashboard-view');
        });
        
        modalCancelBtn.addEventListener('click', hideModal);

        // --- QUIZ LOGIC ---
        const startQuiz = (index) => {
            const quiz = quizzes[index];
            renderQuizTaker(quiz);
            submitQuizBtn.dataset.quizIndex = index;
            showView('take-quiz-view');
            startTimer(600); // 10 minutes
        };

        const startTimer = (duration) => {
            let timer = duration;
            const timerEl = document.getElementById('timer');
            clearInterval(quizTimer);
            quizTimer = setInterval(() => {
                let minutes = parseInt(timer / 60, 10);
                let seconds = parseInt(timer % 60, 10);
                minutes = minutes < 10 ? "0" + minutes : minutes;
                seconds = seconds < 10 ? "0" + seconds : seconds;
                timerEl.textContent = minutes + ":" + seconds;
                if (--timer < 0) {
                    clearInterval(quizTimer);
                    submitQuizBtn.click();
                }
            }, 1000);
        };

        // --- INITIALIZATION ---
        const init = () => {
            loadQuizzesFromStorage();
            renderDashboard();
            switchToAIMode(); // Set default mode on load
            feather.replace();
        };

        init();
    });
    </script>
</body>
</html>

